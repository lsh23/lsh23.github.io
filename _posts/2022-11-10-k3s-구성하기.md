---
title: k3s 구성하기
date: 2022-11-10 22:00:00 +0900
categories: [Container Orchestration, Kubernetes]
tags: [Kubernetes, k3s]
comments: true
---

kubernets 실습 및 스터디를 위한 간단한 k3s 구성하기


## k3s란
k3s는 비교적 설치가 간단하고  
IoT, edge computing 디바이스위에서 동작하도록 만들어진 경량 쿠버네티스이다.


## 구성
OS : ubuntu 22.04  
1개의 master 노드와 2개의 worker 노드로 구성

## 사전 준비
k3s 공식 docs에 cluster 구성을 위해 필요한 networking에 대해 나열되어 있다.  
설치할 노드에 맞게 iptables를 통해서 규칙을 추가해준다.

| Protocol | Port | Source | Description |
|:---------|:-----|:-------|:------------|
| TCP | 6443 | K3s agent nodes | Kubernetes API Server |
| TCP | 10250 | K3s server and agent nodes | Kubelet metrics |

master node
```console
$ sudo iptables -I INPUT -p tcp --dport 6443 -j ACCEPT
$ sudo iptables -I INPUT -p tcp --dport 10250 -j ACCEPT
$ sudo iptables -I INPUT -p tcp --dport 30000:32767 -j ACCEPT # node port
```
worker node
```console
$ sudo iptables -I INPUT -p tcp --dport 10250 -j ACCEPT
$ sudo iptables -I INPUT -p tcp --dport 30000:32767 -j ACCEPT # node port
```

> 사용하는 리소스가 cloud 리소스일 경우 보안그룹에도 규칙을 넣어줘야한다.
{: .prompt-tip }

## maser 노드 설치
아래의 명령으로 설치
```console
$ curl -sfL https://get.k3s.io | sh -
```
설치 후에 worker 노드 설치에 필요한 TOKEN 값 확인
```console
$ cat /var/lib/rancher/k3s/server/node-token
K10373314897d684c2bbd8b01ff147449fa35acaafc9a99e549909f7bcea514070b::server:2dc963b5a5b61b77f94418c811f059f2
```

## worker 노드 설치
```console
$ curl -sfL https://get.k3s.io | K3S_URL=https://10.0.0.24:6443 K3S_TOKEN=K10373314897d684c2bbd8b01ff147449fa35acaafc9a99e549909f7bcea514070b::server:2dc963b5a5b61b77f94418c811f059f2 sh -
```
> K3S_URL는 https://master_node_ip:6443을 넣어준다.
{: .prompt-info }

## 설치 확인 on master
```console
ubuntu@master:~$ sudo kubectl cluster-info
Kubernetes control plane is running at https://127.0.0.1:6443
CoreDNS is running at https://127.0.0.1:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
Metrics-server is running at https://127.0.0.1:6443/api/v1/namespaces/kube-system/services/https:metrics-server:https/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
```
```console
ubuntu@master:~$ sudo kubectl get node
NAME      STATUS   ROLES                  AGE   VERSION
master    Ready    control-plane,master   36m   v1.25.3+k3s1
worker2   Ready    <none>                 28m   v1.25.3+k3s1
worker1   Ready    <none>                 28m   v1.25.3+k3s1
```

## reference
* <https://docs.k3s.io/>
* <https://si.mpli.st/dev/2020-01-01-easy-k8s-with-k3s/>
* <https://cigiko.cafe24.com/ubuntu-20-04-%EC%84%9C%EB%B2%84%EC%97%90-k3s-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EA%B5%AC%EC%84%B1%ED%95%98%EA%B8%B0/>



